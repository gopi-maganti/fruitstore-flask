name: Deploy the Flask App

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 90m
          command_timeout: 60m
          script: |
            set -e

            echo "âœ… Navigating to home directory"
            cd /home/ec2-user

            echo "âœ… Cloning repo if not exists"
            if [ ! -d "fruitstore-flask" ]; then
              git clone https://github.com/${{ github.repository }}.git
            fi

            cd fruitstore-flask

            echo "âœ… Checking out tag ${{ github.event.inputs.tag }}"
            git fetch --all --tags
            git checkout ${{ github.event.inputs.tag }}

            echo "âœ… Removing old OpenSSL to avoid conflict"
            sudo yum remove -y openssl-devel || true

            echo "âœ… Installing system libraries for Python 3.12"
            sudo yum groupinstall -y "Development Tools"
            sudo yum install -y \
              gcc gcc-c++ make zlib-devel libffi-devel bzip2-devel \
              xz-devel ncurses-devel readline-devel sqlite-devel \
              openssl11 openssl11-devel wget tk-devel gdbm-devel libuuid-devel

            echo "âœ… Downloading and building Python 3.12"
            cd /usr/src
            sudo wget https://www.python.org/ftp/python/3.12.2/Python-3.12.2.tgz
            sudo tar xzf Python-3.12.2.tgz
            cd Python-3.12.2
            sudo ./configure --enable-optimizations \
              --with-openssl=/usr/include/openssl11 \
              CPPFLAGS="-I/usr/include/openssl11" \
              LDFLAGS="-L/usr/lib64/openssl11"
            sudo make -j$(nproc)
            sudo make altinstall

            echo "âœ… Verifying SSL support in Python 3.12"
            /usr/local/bin/python3.12 -c "import ssl; print(ssl.OPENSSL_VERSION)"

            echo "âœ… Setting up virtual environment with Python 3.12"
            cd /home/ec2-user/fruitstore-flask
            /usr/local/bin/python3.12 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements/prod-requirements.txt

            echo "âœ… Fetching DB credentials from AWS Secrets Manager"
            python scripts/init_env.py

            echo "âœ… Restarting Flask app with Gunicorn"
            pkill gunicorn || true
            nohup gunicorn -w 4 -b 0.0.0.0:8000 run:app > gunicorn.log 2>&1 &

            echo "ğŸ‰ Deployment completed successfully for tag ${{ github.event.inputs.tag }}"
