name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user || exit 1

            # Clone the repo if not exists
            if [ ! -d \"fruitstore-flask\" ]; then
              git clone https://github.com/${{ github.repository }}
            fi

            cd app
            git fetch --all --tags
            git checkout ${{ github.event.inputs.tag }}

            # Setup Python
            sudo yum install -y python3 git
            pip3 install --upgrade pip

            # If you're using pipenv:
            pip3 install pipenv
            pipenv install --deploy --ignore-pipfile

            echo 'Fetching DB credentials from Secrets Manager'
            pipenv run python scripts/init_env.py

            echo 'Restarting Flask app'
            pkill gunicorn || true
            nohup pipenv run gunicorn app:app --bind 0.0.0.0:5000 &
